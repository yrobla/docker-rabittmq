#!/bin/bash

# check if we have marathon endpoint
echo "Starting cluster"
echo "Endpoint is"
echo $MARATHON_ENDPOINT
if [ ! -z "$MARATHON_ENDPOINT" ]; then
    # curl the url and check if there is a host
    echo "Discovering configuration from $MARATHON_ENDPOINT"
    CLUSTER=`curl -X GET -H "Content-Type: application/json" http://$MARATHON_ENDPOINT/v2/apps/yroblarabbitmq | grep -Po '"host":".*?[^"]"' | sed 's/^.*://' | sed 's/^"\(.*\)"$/\1/'`
fi
echo "Found cluster [$CLUSTER]"
echo "Starting RabbitMQ"
/usr/lib/rabbitmq/bin/rabbitmq-server &
sleep 10
if [[ -z "$CLUSTER" ]]; then
echo "Running as master"
else
echo "Joining cluster at $CLUSTER"
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster $CLUSTER
rabbitmqctl start_app
fi
# Infinite sleep loop to keep docker backgrounding happy
while true; do
sleep 1
done
